<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded',async()=>{
            const frm_duo = document.querySelector('#frm_duo') //form
            const lol_nickname = document.querySelector('#lol_nickname') //닉네임입력
            const register_btn = document.querySelector('#register_btn') //닉네임 저장 버튼
            const duo_search = document.querySelector('#duo_search') //검색
            const vaild = /^[가-힣a-zA-Z0-9\s]+$/

            //한글, 영문, 띄어쓰기만
            const option = { 
            'Content-type':'application/json',
            withCredentials:true,
            }  
            frm_duo.addEventListener('submit',async (e)=>{
                e.preventDefault()
                console.log(vaild.test(lol_nickname.value))
                
                if(lol_nickname.value == "" || !vaild.test(lol_nickname.value)){
                    alert('제대로 된 닉네임을 입력해주세요.')
                }else{
                    const data = {
                        lol_nickname:lol_nickname.value
                    }
                        console.log(data.lol_nickname)

                    const response = await axios.post('http://localhost:4000/api/matching/duo', data, option)
                    console.log(response.data.result)
                    if(response.data.result =="success"){
                        alert('닉네임이 정상적으로 등록되었습니다. 아래 듀오 찾기 버튼을 눌러주세요.')
                    } else if(response.data.result =="failure"){
                        alert('닉네임을 입력해주세요.')
                    } else if(response.data.result == 1062){
                        alert('등록 완료 된 닉네임입니다.')
                    }
                    
                }

                    
            })
            let template = ''
            let duo_list = document.querySelector('#duo_list') //템플릿 넣을 공간
            const duo_temp = document.querySelector('#duo_temp').innerHTML // 템플릿내용
            duo_search.addEventListener('click', async (e)=>{
                e.preventDefault()
                template = ''
                duo_list.innerHTML = ''
                duo_search.value = "로딩 중"
                duo_search.disabled = true
                const response = await axios.post('http://localhost:4000/api/matching/duosearch', null, option)

                const {my_info, match_info} = response.data

                console.log("나랑", my_info, "너희", match_info)
                if(match_info==''){
                    duo_list.innerHTML = " 듀오를 할 수 없는 티어입니다. "
                }else{
                    match_info.forEach((v)=>{
                    const{usernickname, rate, winning_rate} = v
                    template += duo_temp.replace('{usernickname}',usernickname)
                                        .replace('{rate}', rate)
                                        .replace('{winning_rate}', winning_rate)
                })

                duo_list.innerHTML = template
                }
                duo_search.value = '검색'
                duo_search.disabled = false

            })



        })
    </script>
</head>
<body>
    <table width="50%" border=1> 
        <thead>
            <form method="post" id="frm_duo">
                <h1>League of Legends</h1>
                <strong>닉네임</strong>
                <input type="text" placeholder="정확하게 입력해주세요." id="lol_nickname">
                <input type="submit" value="닉네임 등록하기" id="register_btn">
            </form>
            <br>
            <br>
            <strong>이미 등록한 사용자는 찾기 버튼만 눌러주세요.</strong>

            <button id="duo_search">듀오 찾기</button> 
            <h2>듀오 가능 유저 리스트</h2>
            
            <tr>
                <th>유저 닉네임</th>
                <th>티어</th>
                <th>승률</th>
            </tr>
            
        </thead>
        <tbody id="duo_list">

        </tbody>
    </table>
    <template id="duo_temp">
        <tr>
            <th>{usernickname}</th>
            <th>{rate}</th>
            <th>{winning_rate}</th>
        </tr>
    </template>

</body>
</html>