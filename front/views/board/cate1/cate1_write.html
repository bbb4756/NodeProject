<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            let hiddenSpan = document.querySelector('#hidden')
            let nickInput = document.querySelector('#nickname')
            const categoryElement = document.querySelector('#category') //셀렉트박스
            const category = location.href.split('/')[5].replace('write?category=','')
            const cate1 = document.querySelector('#cate1')
            const code_question = document.querySelector('#code_question')
            const QnA = document.querySelector('#QnA')
            const request = document.querySelector('#request')
            console.log("라이트페이지", category)
            nickInput.disabled= true
            hiddenSpan.disabled = true

            if(category == "QnA"){
                QnA.selected = true
            } else if(category == "request"){
                request.selected = true
            } else if(category == "question"){
                code_question.selected = true
            }

        })
    </script>
    <style>
        #hidden {
            display:none;
        }
    </style>
</head>

<body>
    <div>
        <h1>write 페이지</h1>
    </div>
    
    <span id="hidden"> {{ userid }} </span>
    
    <form method="post" action="http://localhost:4000/api/board/cate1/imageUpload" id="write_frm" enctype="multipart/form-data">
        <input type="text" name="nickname" id="nickname" value="{{nickname}}">
        <div>
            <strong>제목</strong> <br>
            <input type="text" name="title" placeholder="제목입력" id="title" value="cate1">
        </div>
        <div>
            <strong>category</strong> <br>
            <!-- <input type="text" name="category" placeholder="카테고리 선택", id="category" value="cate1"> -->
            <select name="category" id="category" >
                <option value="" disabled> 카테고리 선택</option>
                <option value="cate1" id="cate1"selected>자유 게시판</option>
                <option value="code_question" id="code_question">코드 자문 게시판</option>
                <option value="QnA" id="QnA">Q&A 게시판</option>
                <option value="request" id="request">청원 게시판</option>
            </select>
        </div>
        <div>
            <strong>내용</strong> <br>
            <textarea name="content" placeholder="내용입력" id="content" > aaa</textarea>
        </div>
        <div>
            <span >사진 업로드 </span>
            <span>
                <input type="file" name="img1" id="img1">
                <input type="file" name="img2" id="img2">
                <input type="file" name="img3" id="img3">
                <input type="file" name="img4" id="img4">
                <input type="file" name="img5" id="img5">
            </span>
        </div>
        <br>

        <div id="ht_frm">
            <input id="hashtag" name="hashtag" placeholder="hashtag를 입력해주세요">
            <div id="ht_wrap"></div>
        </div>
        <input type="submit" value="글작성">
    </form>

    <script type="text/javascript">
        const htForm = document.querySelector('#ht_frm')
        const htText = document.querySelector('#hashtag')
        const category = document.querySelector('#category')
        

        htForm.addEventListener('keydown', (e) => {
            if (e.keyCode === 13) {
                const htDelete = document.createElement('span')
                htDelete.innerHTML = 'X_'
                htDelete.setAttribute('class', `htDeleter`)
                
                const htElement = document.createElement('span')
                const htElement2 = document.createElement('sapn')
                htElement.setAttribute('class', `hashtags`)
                htElement2.setAttribute('class', `hashtagsform`)
                htElement2.innerHTML='#'
                htElement.innerHTML = `${htText.value}`

                const htDiv = document.createElement('div')
                htDiv.append(htDelete)
                htDiv.append(htElement2)
                htDiv.append(htElement)
                
                
                htForm.append(htDiv)
                htText.value = ''

                const htDeleteHandler = document.querySelectorAll('.htDeleter')
                for(i = 0; i<htDeleteHandler.length; i++) {
                    htDeleteHandler[i].addEventListener('click', (e) => {
                        e.target.parentNode.remove()
                    })
                }
            }
        })
        // enter를 이용해 해시 태그 추가, 삭제
        
        const write_frm = document.querySelector('#write_frm')
        write_frm.addEventListener('keydown', (e) => {
            if(e.keyCode === 13) {
                e.preventDefault()
            }
        })
        // 엔터 누르면 글 작성이 완료되어버리는 것 방지

        write_frm.addEventListener('submit', async(e) => {
            e.preventDefault()

            const option = {
                'Content-type':'application/json',
                withCredentials:true
            }

            const userid = document.querySelector('#hidden')
            const nickname = document.querySelector('#nickname')
            const title = document.querySelector('#title')
            const content = document.querySelector('#content')
            
            const hashtagss = document.querySelectorAll('.hashtags')
            let temphash = []

            for (i=0; i<hashtagss.length; i++) {
                temphash.push(hashtagss[i].innerHTML)
            }

            const formData = new FormData()
            formData.append('category', document.querySelector('#category').value)
            formData.append('img1', img1.files[0])
            formData.append('img2', img2.files[0])
            formData.append('img3', img3.files[0])
            formData.append('img4', img4.files[0])
            formData.append('img5', img5.files[0])

            const data = { 
                userid : userid.innerHTML,
                category: category.value,
                nickname:nickname.value,
                title : title.value,
                content : content.value,
                temphash
            }

            const response = await axios.post('http://localhost:4000/api/board/cate1/write', data, option)

            // console.log(response.data.insertId)

            formData.append('midx', response.data.insertId)


            const responseImgup = await axios.post('http://localhost:4000/api/board/cate1/imageUpload', formData, option)
            // console.log(responseImgup)

            if (response.data.errno === 0) {
                alert('글 작성이 완료되었습니다.')
                location.href=`/board/${category.value}`
            }
            else {
                alert('글 작성중 문제가 발생하였습니다.')
            }
        })
    </script>
</body>
</html>