{% extends 'utils/header.html' %}

{% block content %}
<body>
    <div id="useruser">
        <span id="userid">{{userid}}</span>
        <span id="mynick" style ='display: none;'>{{nickname}}</span>
    </div>
    <div id="view_wide">
        <div id="view_wrap">
            <dl>
                <dt id="view_dt">
                    <div id="view_title">
                        <span id="title">{{cate1_view.title}}</span>
                    </div>
                    <div id="view_head">
                        <span id="category">{{cate1_view.category}}</span>
                        <span id="view_date">{{ cate1_view.date }}</span>
                        <span id="writerid">{{cate1_view.userid}}</span>
                        <span id="nickname"><a id='userinfo' href="/user/profile?nickname={{cate1_view.nickname}}">{{ cate1_view.nickname }}</a></span>
                    </div>
                </dt>
                <dd id="view_dd">
                    <div id="view_content">
                        <div id="view_userimg">
                            <span id="userimg"></span>
                        </div>
                        {{ cate1_view.content }}
                    </div>
                    <div id="view_good">
                        <form method="post" action="http://localhost:4000/api/board/cate1/like" id="like">
                            <input type="submit" value="üíó" id="thumb">
                        </form>
                    </div>
                    <div id="view_like">
                        <span id="likecount"></span>
                    </div> 
                </dd>
                <div id="view_form">
                    <div id="view_modify">
                        <a href='/board/cate1/update?idx={{cate1_view.idx}}' id="form_lk">ÏàòÏ†ï</a>
                    </div>
                    <form method="post" action="http://localhost:4000/api/board/cate1/delete" id="del_frm">
                        <input type="hidden" name='idx' value="{{cate1_view.idx}}" id="idx"> 
                        <input type="submit" value="Í∏Ä ÏÇ≠Ï†ú" id="view_form_sub">
                    </form>
                </div>
                <div id="view_hash">
                    Hashtag : 
                    {% for item in cate1_hashtag %}
                    <span>#{{item.hashtag_name}}</span>
                    {% endfor %}
                </div>  
            </dl>
        </div>
        <!-- <div>
            <ul id="commentApp">
            </ul>
        </div> -->
        <!-- ÎåìÍ∏ÄÏãúÏä§ÌÖú Î†åÎçîÎßÅÌïòÎäî div-->
        <div id="view_cmt">
            <div id="view_app">
                <ul id="commentApp">
                </ul>
            </div>
            <template id="commentForm">
                <li class="comment-form">
                    <form method="post" action="" class="cmt_frm">
                        <h4>ÎåìÍ∏Ä <span>()</span> </h4>
                        <span class="ps_box">
                            <input type="text" placeholder="Ïó¨Îü¨Î∂ÑÏùò ÏÜåÏ§ëÌïú ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî." class="int" value="" name="input">
                        </span>
                        <input type="submit" class="btn" value="ÎåìÍ∏ÄÎã¨Í∏∞" />
                    </form>
                </li>
            </template>
            <!-- ÎåìÍ∏Ä ÏûëÏÑ± -->
            <template id="commentList">
                <li class="c_list">
                    <ul class="comment-row">
                        <li class="comment-id"></li>
                        <li class="comment-content">    
                            <input type="hidden" name="idx" value=""/>
                            <span class="comment-delete-btn">X</span>
                        </li>
                        <li class="comment-date"></li>
                    </ul>
                </li>
            </template>
            <!-- ÎåìÍ∏Ä Î™©Î°ù -->
            <template id="commentInput">
                <span>
                    <input type="text" class="comment-update-input" value="">
                </span>
            </template>
        </div>
        <div id="view_list">
            <a href="/board/cate1" class="v_list">Í∏Ä Î™©Î°ù</a>
        </div>
    </div>
    
    <script type="text/javascript">
        const option = {
            'Content-type':'application/json',
            withCredentials:true
        }
        const idx = document.querySelector('#idx')
        const category = document.querySelector('#category')
        const userid = document.querySelector('#userid')

        document.addEventListener('DOMContentLoaded', async() => {
            const likeCount = document.querySelector('#likecount')
            const idx = document.querySelector('#idx')

            const data = {
                idx:idx.value
            }

            const response = await axios.post('http://localhost:4000/api/board/cate1/likeCount', data, option)
            let [likeNum] = Object.values(response.data.result[0])
            likeCount.innerHTML =likeNum

            const response2 = await axios.post('http://localhost:4000/api/board/cate1/viewuser', null, option)
            const Usernick = response2.data.result[0].nickname
            let nickname = "{{cate1_view.nickname}}"

            if(nickname !== Usernick){
              
            } else{

            }
            
        })

        // Ï¢ãÏïÑÏöî ÎàÑÎ•¥Í∏∞(done)
        const like = document.querySelector('#like')

        like.addEventListener('submit', async (e) => {
            e.preventDefault()

            const idx = document.querySelector('#idx')
            const userid = document.querySelector('#userid')

            const data = {
                userid:userid.innerHTML,
                idx: idx.value
            }

            const response = await axios.post('http://localhost:4000/api/board/cate1/like', data ,option)
            const likeCount = document.querySelector('#likecount')
            if (response.data.errno === 1) {
                alert('Ï¢ãÏïÑÏöîÎ•º Ï∑®ÏÜåÌïòÏòÄÏäµÎãàÎã§')
                likeCount.innerHTML--
            }
            else {
                alert('Ïù¥ Í≤åÏãúÎ¨ºÏùÑ Ï∂îÏ≤úÌñàÏäµÎãàÎã§.')
                likeCount.innerHTML++
            }
        })

        
        // Í∏Ä ÏÇ≠Ï†ú

        const delForm = document.querySelector('#del_frm')      
        delForm.addEventListener('submit', async (e) => {
            e.preventDefault()

            const idx = delForm.querySelector('#idx')
            const writerid = document.querySelector('#writerid')
            const userid = document.querySelector('#userid')

            const data = {
                idx:idx.value,
                category:category.innerHTML,
                writerid:writerid.innerHTML,
                userid:userid.innerHTML
            }

            const response = await axios.post('http://localhost:4000/api/board/cate1/delete', data, option)

            if(response.data.errno === 0 ) {
                alert('Í∏Ä ÏÇ≠Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.')
                location.href='/board/cate1'
            }
            else {
                alert('ÏàòÌñâÌï† Ïàò ÏóÜÎäî Î™ÖÎ†πÏûÖÎãàÎã§.')
            }
        })

        //
        //

        let state = {}
        state.comment=[]
        state.length=''

        document.addEventListener('DOMContentLoaded', async () => {
            const imgZone = document.querySelector('#userimg')
            const icategory = "{{cate1_image.category}}"
            const midx = "{{cate1_image.midx}}"
            const img1 = "{{cate1_image.img1}}"
            const img2 = "{{cate1_image.img2}}"
            const img3 = "{{cate1_image.img3}}"
            const img4 = "{{cate1_image.img4}}"
            const img5 = "{{cate1_image.img5}}"

            const tempImgArr = [img1, img2, img3, img4, img5]

            const imgArr = []

            for (let i =0; i<tempImgArr.length; i++) {
                if(tempImgArr[i] !== 'N/A') {
                    imgArr.push(tempImgArr[i])
                }
            }

            for ( let i =0; i<imgArr.length; i++) {
                const imgSpan = document.createElement('span')
                const imgElement = document.createElement('img')
                imgElement.setAttribute('src', `http://localhost:4000/uploads/${imgArr[i]}`)
                imgSpan.append(imgElement)
                imgZone.append(imgSpan)
            } 
        })
        //
        //
        document.addEventListener('DOMContentLoaded', async () => {
            const uri = location.pathname
            const cate = document.querySelector('#category').innerHTML
            const data = {
                idx:idx.value,
                cate:cate,
            }

            const replyResponse = await axios.post('http://localhost:4000/api/board/comment/view', data, option)

            let comment = replyResponse.data.result1 // array
            let length = replyResponse.data.result1.length
            
            state = {
                ...state,
                comment:comment,
                length:length
            }

            const commentApp = document.querySelector('#commentApp')
            const commentForm = document.querySelector('#commentForm')
            const commentList = document.querySelector('#commentList')
            const commentInput = document.querySelector('#commentInput')

            // Í∞ÄÏû• ÏïÑÎûò commentView() Ìï®ÏàòÍ∞Ä ÏûàÎã§. Í∑∏Í≤å Ïö∞ÏÑ† Ïã§ÌñâÎêúÎã§. = ÏõêÎûò ÏûàÎäî ÎåìÍ∏ÄÎì§ÏùÑ Î≥¥Ïó¨Ï§ÄÎã§.
            // Í∑ºÎç∞ Í∑∏ ÏïàÏóê createForm() Ïù¥ ÏûàÍ≥†, Í∑∏ ÏïàÏóê submitHandlerÍ∞Ä ÏûàÎã§.
            // ÎÖºÎ¶¨ Íµ¨Ï°∞ Ìïú Î≤à ÏãúÎ∞ú Î≥µÏû°ÌïòÎÑ§..
        
            function commentView() {
                commentApp.innerHTML = '' // ÎåìÍ∏Ä zone Ï¥àÍ∏∞Ìôî
                createForm()

                state.comment.forEach(v => { // Í∞ÅÍ∞ÅÏùò ÎåìÍ∏ÄÏóê ÎåÄÌï¥ Ïã§Ìñâ
                    const clone = document.importNode(commentList.content, true)
                    // CommentList ÌÖúÌîåÎ¶øÏùò ÎÇ¥Ïö©Î¨ºÏùÑ Í∞ÄÏ†∏Ïò®Îã§
                    const row = clone.querySelectorAll('.comment-row > li')
                    // Í∑∏ ÏïàÏóêÏÑú li elementÎì§ÏùÑ Ï£ÑÎã§ ÏÑ†ÌÉù
                    row[0].innerHTML = v.userid
                    // Ï≤´ Î≤àÏß∏ listÎäî userid ÏûÖÎ†•
                    row[1].querySelector('input').value = v.idx
                    // Îëê Î≤àÏß∏ liÎäî idx ÏûÖÎ†•
                    
                    if ( v.updateFlag == 'true') {
                        const spanElement = document.createElement('span')
                        spanElement.innerHTML = v.content
                        // span elementÎ•º ÎßåÎì§Ïñ¥ ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÎÑ£ÎäîÎã§.
                        const deleteBtn = row[1].querySelector('.comment-delete-btn')
                        // 'X' Í∞Ä ÏûàÎäî span ÏÑ†ÌÉù 
                        spanElement.addEventListener('click',updateHandler)
                        // ÎåìÍ∏ÄÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏàòÏ†ï Ìï®Ïàò Ïã§Ìñâ ÎêòÍ≤å addEventListener
                        deleteBtn.addEventListener('click',deleteHandler)
                        // 'X' ÌÅ¥Î¶≠Ïãú ÏÇ≠Ï†ú Ìï®Ïàò Ïã§Ìñâ
                        row[1].prepend(spanElement)
                        // prependÎäî appendÏôÄ ÎèôÏùºÌïòÏßÄÎßå Í∞ÄÏû• ÏïûÏóê ÏöîÏÜåÍ∞Ä Ï∂îÍ∞ÄÎê®
                    } 
                    else {
                        const clone = document.importNode(commentInput.content,true)
                        clone.querySelector('input').value = v.content
                        clone.querySelector('input').addEventListener('keypress',updateSubmitHandler)
                        row[1].prepend(clone)
                    }

                    row[2].innerHTML = v.date

                    commentApp.appendChild(clone)
                })
            }

            function createForm(){
                const clone = document.importNode(commentForm.content, true) // commentForm ÏïàÏóê ÏûàÎäî ÏöîÏÜåÎì§ÏùÑ Í∑∏ÎÉ• Í∞ÄÏ†∏Ïò®Í±∞ÏûÑ.
                const form = clone.querySelector('form') // Í∑∏Ï§ë formÏùÑ ÏÑ†ÌÉù
                const counting = form.querySelector('h4 > span') // Îπà Í¥ÑÌò∏ ÎßêÌïòÎäîÍ±∞
                counting.innerHTML = `(${state.comment.length})` // Í∑∏ Îπà Í¥ÑÌò∏Ïóê ÎåìÍ∏Ä Í∞ØÏàòÎ•º ÎÑ£ÎäîÎã§.

                form.addEventListener('submit',submitHandler)
                commentApp.append(clone) // ÎåìÍ∏Ä areaÏóê cloneÏùÑ ÌÜµÌï©
            }
            // ÎåìÍ∏Ä Ïì∞Îäî Î™®Îìà

            async function submitHandler (e){
                e.preventDefault()
                const { input } = e.target // ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî ÌïòÎäî Í∑∏ input

                const counting = e.target.querySelector('h4 > span')
                // Îπà Í¥ÑÌò∏ > createFormÏù¥ Ïã§ÌñâÎêú ÌõÑÏóî ÎåìÍ∏ÄÏùò Í∞ØÏàòÍ∞Ä Ï±ÑÏõåÏßê
                const length = state.length
                const cidx = length != 0 ? parseInt(state.length + 1 ) : 1 
                // lengthÍ∞Ä 0 Ïù¥ ÏïÑÎãàÎ©¥ Îëê Î≤àÏß∏ Ìï≠, 0Ïù¥Î©¥ ÏÑ∏Î≤àÏß∏ Ìï≠ÏùÑ valueÎ°ú Í∞ÄÏßê
                // idxÎäî ÎåìÍ∏ÄÏù¥ ÌòÑÏû¨ Í∏ÄÏùò Î™á Î≤àÏß∏ ÎåìÍ∏ÄÏù∏ÏßÄÎ•º ÏïåÎ†§Ï§ÄÎã§. 
                // Í∑∏ÎûòÏÑú ÏßÄÍ∏àÍπåÏßÄ Îã® ÎåìÍ∏Ä ÏàòÎ•º Î®ºÏ†Ä Í≥ÑÏÇ∞ÌïòÎäîÍ≤å 2Î≤àÏß∏ Ìï≠Ïù¥Í≥†, 
                // ÏóÜÏúºÎ©¥ ÏÑ∏Î≤àÏß∏Ìï≠Ïùò valueÏù∏ 1ÏùÑ Í∞ÄÏßÄÎäîÍ≤É.

                //ÎÇ†Ïßú
                let today = new Date()
                let year = today.getFullYear()
                let month = ('0' + (today.getMonth() + 1)).slice(-2)
                let day = ('0' + today.getDate()).slice(-2)

                let dateString = year + '-' + month + '-' + day

                //ÏãúÍ∞Ñ
                let today2 = new Date()
                let hours = ('0' + today2.getHours()).slice(-2)
                let minutes = ('0' + today2.getMinutes()).slice(-2)
                let seconds = ('0' + today2.getSeconds()).slice(-2)

                let timeString = year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds
               
    
                const result = {idx,userid:'{{userid}}', content:input.value, date:timeString, updateFlag:'true'}
                // ÎåÄÏ∂© Ï†Ä state.replay Ï≤òÎüº Ìè¨Îß∑ ÎßåÎì§Ïñ¥Ï§ÄÎã§.
                state = {
                    ...state,
                    comment:[
                        ...state.comment,
                        result
                    ],
                    length:replyResponse.data.result1.length + 1
                }
                // state Î≥ÄÏàòÎ•º ÏóÖÎç∞Ïù¥Ìä∏ Ìï¥Ï§ÄÎã§. Î∞©Í∏à Ïì¥ ÎåìÍ∏ÄÏùÑ Ï∂îÍ∞ÄÌïòÍ≥†, length Í∞íÏùÑ 1 ÎçîÌïúÎã§.

                const mynick = document.querySelector('#mynick')
                const content = input.value
                const userid = document.querySelector('#userid')
                
                const data = {
                    cate: cate,
                    idx: idx.value,
                    content: content,
                    nickname:mynick.innerHTML,
                    userid:userid.innerHTML
                }
                
                const replyAdd = await axios.post('http://localhost:4000/api/board/comment/add', data, option)
                console.log(replyAdd.data.insertId)
                 

                // row[1].querySelector('input').value = replyAdd.data.insertId.value // !!!!!!!!!!!!!!!!!!!!!!!!
                input.value = '' // ÎåìÍ∏Ä Îì±Î°ùÌïòÎ©¥ formÏùÄ Îã§Ïãú Îπà Ïπ∏Ïù¥ ÎêúÎã§.
                counting.innerHTML = `(${state.length})` // ÌôîÎ©¥Ïóê Î†åÎçîÎßÅÎêòÎäî ÎåìÍ∏Ä ÏàòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ Ìï¥Ï§ÄÎã§.
                
                commentView()

                const comments = commentApp.querySelectorAll('li')
                const newComment = comments[comments.length-2]
                console.log(newComment)
                const newCommentInput = newComment.querySelector('input')
                newCommentInput.value = replyAdd.data.insertId
                console.log(state)
            }

            //

            function updateHandler(e){
                const idx = parseInt( e.target.parentNode.querySelector('input').value )
                const newReply = [...state.comment]
                let index 

                for (let i =0; i < newReply.length; i++){
                    if (newReply[i].idx === idx){
                        index = i
                    }
                }

                newReply[index].updateFlag = 'false'
                console.log(idx,newReply)
                state = {
                    ...state,
                    replay:newReply
                }

                commentView()
            }

            async function updateSubmitHandler(e){
                
                if(e.keyCode === 13) {
                    
                    const idx = parseInt( e.target.parentNode.parentNode.querySelector('input[type=hidden]').value )
                    console.log(e.target.parentNode.querySelector('input').value)
                    // ÎåìÍ∏Ä ÌÖåÏù¥Î∏îÏùò pkÏù∏ idx ÏùòÎØ∏
                    const content = e.target.parentNode.querySelector('input').value
                    const data = { 
                        idx:idx,
                        content: content
                    }
                    const updateReply = await axios.post('http://localhost:4000/api/board/comment/update', data, option)

                    const newReplay = [...state.replay]
                    let index 
                    for(let i =0; i < newReplay.length; i++){
                        if(newReplay[i].idx === idx){
                            index = i
                        }
                    }

                    newReplay[index].updateFlag = 'true'
                    newReplay[index].content = e.target.value

                    state = {
                        ...state,
                        comment:newReplay
                    }

                    commentView()
                }
            }

            async function deleteHandler(e){
                const idx = parseInt( e.target.parentNode.querySelector('input').value )
                
                const data = {
                    idx:idx                    
                }
                
                const commentDel = await axios.post('http://localhost:4000/api/board/comment/delete', data ,option)

                const newReply = state.comment.filter(v => v.idx !== idx)
                state = {
                    ...state,
                    comment:newReply,
                    length:newReply.length
                }
                commentView()
            }

            commentView()

            
        })
    </script>
    <style>
        #footer_wrap {
        bottom: -450px !important;
        position: relative;
    
    }
    </style>
{% endblock %}